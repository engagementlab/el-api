mixin header(nomenu)
  html
    head
      title='Engagement Lab Content Manager'
      meta(http-equiv='Content-type' content='text/html; charset=utf-8')
      meta(name='viewport' content='width=device-width, initial-scale=1')
      meta(name='robots' content='noindex, nofollow')
      link(rel='stylesheet', href='/cms/style/global', type='text/css')
      script(src='https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js')
      script(src='https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js')
      script(src='https://cdn.jsdelivr.net/npm/greensock@1.20.2/dist/TweenMax.min.js')
      link(rel='stylesheet', href='https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css', type='text/css')

    body(style='background:#FAFBFB')
      .ui.grid#header
        .four.column.row
          .left.floated.column
            img(src='https://res.cloudinary.com/engagement-lab-home/image/upload/c_scale,f_auto,w_55/v1543874087/logos/logo-sm-black.svg') 
            span   Engagement Lab Content Manager 
              br
              span#version v#{version}
          
          if !nomenu
            .column#profile
              .ui.inline.dropdown
                button#open 
                  img(class='ui circular mini image' src=''+userPic)

                .menu
                  if apps && Object.keys(apps).length > 1
                    .header Switch App
                    each val in Object.keys(apps)
                      a.item.app(class={active: schema===apps[val].dir})(id=''+apps[val].dir) #{apps[val].name}
                  if isAdmin
                    .header Admin
                    a.item(href='/cms/admin', class={active: onAdmin}) Manage Users

                  .header
                  a.item.yellow#deploy(href='#', onclick="openDeploy()") Deploy to Production
                  .logout
                    button.negative.ui.button#logout Logout

      .ui.modal
        i.close.icon
        .header
          | Deploy to Production 
        .description
          | This action will copy the content from the current QA build of #[#{apps[schema].name}] to production. Before doing this, please ensure the QA build is free of all content issues and any bugs that may be caused by missing or poor-quality content (e.g. images). This action is not easily reversible, and all content from QA will generally be immediately viewable by all users.
          p
          .ui.toggle.checkbox#enable-deploy
            input(type='checkbox' checked=false)
            label I Understand
        .actions
          button.ui.button#deploy-btn Deploy

    script.
      $('.item.app:not(.active)').click(function (e) {
        if (e.target.id)
          window.location = `${window.location.origin}/cms/go/${e.target.id}`;
      });
      $('.ui.dropdown')
        .dropdown();
      $('#logout').click(function (e) {
        e.preventDefault();
        window.location = `${window.location.origin}/cms/logout`;
      });
      $('#enable-deploy input').change(function() {
        if(this.checked)
          $('#deploy-btn').show();
        else
          $('#deploy-btn').hide();
      });

      $('#deploy-btn').click(function (e) {

        $(e.currentTarget).addClass('loading');

        fetch(`${window.location.origin}/cms/admin/deploy/mapping-impactful-media`)
          .then(function (response) {
            return response.json();
          }).then(function (data) {
            if (data.msg === 'done') {
              $(e.currentTarget).removeClass('loading');

              $('.ui.modal')
                .modal('hide');
              TweenMax.fromTo('#deployed', .6, {
                autoAlpha: 0,
                scale: 0
              }, {
                autoAlpha: 1,
                scale: 1,
                display: 'block',
                yoyo: true,
                repeat: 1,
                repeatDelay: 2,
                ease: 'back.out(1.7)'
              });
            }
          });

      });

      function openDeploy() {
        $('.ui.modal')
          .modal('show');
      }