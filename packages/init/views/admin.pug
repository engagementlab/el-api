extends header.pug
block head
    script(src='https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js')
    script(src='https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js')
    link(rel='stylesheet', href='https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css', type='text/css')
    link(rel='stylesheet', href='/cms/style/admin', type='text/css')

block content
    h3 User Administration

        #saved
            span Saved!

        each user,index in users
            .ui.styled.accordion
                div(class={active: index === 0, title: true} data-id=user._id)
                    i.dropdown.icon
                    strong #{user.name}
                div(class={active: index === 0, content: true})
                    p #{user.email}
                    .content.ui.two.column.grid.container
                        .column
                            select.ui.fluid.dropdown(id=user._id, data-preselect=user.permissions multiple='')
                                option(value='') App Access
                                each val,index in apps
                                    option(value=val.dir) #{val.name}
                        .column
                            .ui.checkbox(data-children-count='1')
                                input(type='checkbox')
                                label Is Admin
                            

    script.
        
        $('.ui.dropdown').each(((i, el) => {            
            let pre = $(el).find('select').data('preselect');
            //- $(el).dropdown('set selected', pre);

            $(el).dropdown({values: pre, onChange: function(value, text, $selectedItem) {
                let body = {
                    userId: $(this).attr('id'),
                    values: value,
                };
                fetch('http://localhost:3000/cms/admin/edit', {
                    method: 'post',
                    body: JSON.stringify(body),
                    headers: { 'Content-Type': 'application/json' },
                }).then(function(response) {
                    return response;
                }).then(function(data) {
                    console.log(data)
                    $('#saved').addClass('open')
                });
            }});
        }));

        $('.ui.accordion').accordion({exlusive: true, collapsible: true,});

        function toggleUser(evt) {
            
            let items = document.querySelectorAll('ul li');
            items.forEach((item) => {
                item.classList.remove('active');
            });
            evt.currentTarget.classList.toggle('active');

        }